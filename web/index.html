<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WS Chat Test</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          "Segoe UI",
          Roboto,
          "Noto Sans TC",
          Arial,
          sans-serif;
        margin: 16px;
      }
      #log {
        border: 1px solid #ccc;
        padding: 10px;
        height: 280px;
        overflow: auto;
        white-space: pre-wrap;
      }
      .row {
        margin: 10px 0;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      input {
        padding: 8px;
      }
      button {
        padding: 8px 12px;
        cursor: pointer;
      }
      #msg {
        flex: 1;
        min-width: 220px;
      }
    </style>
  </head>
  <body>
    <h2>WebSocket Chat Test</h2>

    <div class="row">
      <label>
        æš±ç¨±ï¼š
        <input id="name" placeholder="è¼¸å…¥ä½¿ç”¨è€…åç¨±" />
      </label>

      <button id="connectBtn">Connect</button>
      <button id="disconnectBtn" disabled>Disconnect</button>
    </div>

    <div id="log"></div>

    <div class="row">
      <input id="msg" placeholder="è¼¸å…¥è¨Šæ¯å¾ŒæŒ‰ Enter æˆ– Send" disabled />
      <button id="sendBtn" disabled>Send</button>
    </div>

    <script>
      let ws = null;

      const logEl = document.getElementById("log");
      // å…ˆè§£æ±ºæ‹¿åˆ° é€²å…¥æˆ¿é–“çš„äººçš„åå­—ï¼ŒæŠŠé‚£äººçš„åå­—åšç‚ºåƒæ•¸é€£åŒwebsocketä¸€èµ·å‚³é€
      const nameEl = document.getElementById("name");
      const msgEl = document.getElementById("msg");
      const connectBtn = document.getElementById("connectBtn");
      const disconnectBtn = document.getElementById("disconnectBtn");
      const sendBtn = document.getElementById("sendBtn");

      function log(line) {
        const time = new Date().toLocaleTimeString();
        logEl.textContent += `[${time}] ${line}\n`;
        logEl.scrollTop = logEl.scrollHeight;
      }

      function setConnected(isConnected) {
        connectBtn.disabled = isConnected;
        disconnectBtn.disabled = !isConnected;
        msgEl.disabled = !isConnected;
        sendBtn.disabled = !isConnected;
      }

      function connect() {
        if (ws && ws.readyState === WebSocket.OPEN) return;

        // å‰ç«¯ connect ç”¨ name å»ºé€£ç·šï¼ˆè€Œä¸æ˜¯ send æ™‚æ‹¼å­—ä¸²ï¼‰
        const name = nameEl.value.trim() || "anonymous";
        console.log('name:', name);
        // å•Ÿç”¨çš„æ™‚å€™è¦ç¢ºèªå¾Œç«¯çš„ portç¢ºå¯¦æ˜¯ 8080
        ws = new WebSocket(
          `ws://localhost:8080/ws?name=${encodeURIComponent(name)}`,
        );

        ws.onopen = () => {
          log("âœ… Connected");
          setConnected(true);
          msgEl.focus();
        };

        ws.onmessage = (e) => {
          log(`ğŸ“© ${e.data}`);
        };

        ws.onclose = () => {
          log("ğŸ”Œ Disconnected");
          setConnected(false);
        };

        ws.onerror = (err) => {
          log("âŒ WebSocket error (see console)");
          console.error(err);
        };
      }

      function disconnect() {
        if (ws) ws.close();
      }

      function send() {
        if (!ws || ws.readyState !== WebSocket.OPEN) return;

        const text = msgEl.value.trim();
        if (!text) return;

        const name = nameEl.value.trim();
        const payload = name ? `${name}: ${text}` : text;

        ws.send(payload);
        msgEl.value = "";
        msgEl.focus();
      }

      connectBtn.addEventListener("click", connect);
      disconnectBtn.addEventListener("click", disconnect);
      sendBtn.addEventListener("click", send);

      msgEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") send();
      });

      // æ–¹ä¾¿ä½ ä¸€æ‰“é–‹å°±æ¸¬ï¼šè‡ªå‹•é€£ç·šï¼ˆä¸æƒ³è‡ªå‹•å°±åˆªæ‰é€™è¡Œï¼‰
      connect();
    </script>
  </body>
</html>
